var isLeavingPage=!1;$(window).bind("beforeunload",function(){isLeavingPage=!0}),function(){function e(n){function t(e,n){h.debugMessage("jiver web socket start"),h.recvBuf="",n.lastMessageTS=(new Date).getTime(),e.onmessage=function(e){var s,t,i,u;for(n.lastActiveTS=(new Date).getTime(),h.recvBuf+=e.data,s=h.recvBuf.split("\n"),""!=s[s.length-1]?(h.recvBuf=s[s.length-1],s[s.length-1]=""):h.recvBuf="",t=0;t<s.length;t++)0!=s[t].trim().length&&(i=s[t].substring(0,4),u=s[t].substring(4),(0!==i.trim().length||0!==u.trim().length)&&("PONG"===i&&a(!1),n.onmessage(i,u),n.lastMessageTS=n.lastMessageTS>JSON.parse(u).ts?JSON.parse(u).ts:n.lastMessageTS))},e.onopen=function(e){n.onopen(e),i(!0)},e.onerror=function(e){n.onerror(e),i(!1),a(!1)},e.onclose=function(e){n.onclose(e),i(!1),a(!1)}}function a(e){null!=b&&(clearInterval(b),b=null),e?(h.debugMessage("Watchdog starts."),b=setInterval(function(){var e=(new Date).getTime(),n=e-F.lastActiveTS,s=parseInt(n/1e3);20>s||(h.debugMessage("Watchdog Barks!"),i(!1),h.close(),h.reconnect())},4500)):h.debugMessage("Watchdog stops.")}function i(e){null!=S&&(clearInterval(S),S=null),e?(h.debugMessage("Pinger starts."),S=setInterval(function(){var e=(new Date).getTime(),n=e-F.lastActiveTS,s=parseInt(n/1e3);s>0&&s%5==0&&(h.debugMessage(x[G]),h.ping(),a(!0))},1e3)):h.debugMessage("Pinger stops.")}var h,m,M,S,b,y,k,T,O,N,R,P,J,I,w,L,B,D,G,j,x,F;return!this instanceof e?new e(arguments):(s(n.app_id),h=this,m=null,M=null,S=null,b=null,y=!1,h.user={},$.extend(this.user,n),k=this.user.app_id,T=this.user.guest_id,O=null,N=0,h.channel={},R="wss://ws.jiver.co:9010",P="MESG",J="SYSM",I="FILE",w="BRDM",L="STRU",B="LOGI",D="JOIN",G="PING",j="PONG",x={"MESG":P,"SYSM":J,"FILE":I,"BRDM":w,"STRU":L,"LOGI":B,"JOIN":D,"PING":G,"PONG":j},h.events={"onMessageReceived":function(e){console.log(e)},"onSystemMessageReceived":function(e){console.log(e)},"onFileMessageReceived":function(e){console.log(e)},"onBroadcastMessageReceived":function(e){console.log(e)},"onStructuedMessageReceived":function(e){console.log(e)},"onUndefinedMessageReceived":function(e,n){h.debugMessage(e),h.debugMessage(n)}},h.options={"onopen":function(){h.login(h.user.guest_key),h.join(h.channel.id,N)},"onmessage":function(e,n){h.messageProcess(e,n)},"onclose":function(){h.debugMessage("on close"),isLeavingPage||h.reconnect()},"onerror":function(){h.debugMessage("on error"),isLeavingPage||h.reconnect()},"lastActiveTS":0,"lastPingTS":0,"lastMessageTS":0},F=h.options,h.setDebugMessage=function(e){y=e},h.debugMessage=function(e){y&&console.log(e)},h.start=function(){h.user.guest_key=u(h.user)},h.joinChannel=function(e){var n=o(h.user,e);return $.extend(h.channel,n),h.debugMessage(h.channel),h.connect(),h.channel},h.connect=function(){h.debugMessage("try connect"),h.clear(),m=$.gracefulWebSocket(R),t(m,F)},h.clear=function(){m&&(m.onmessage=function(){},m.onopen=function(){},m.onerror=function(){},m.onclose=function(){},m=null)},h.messageProcess=function(e,n){switch(e){case x[P]:h.events.onMessageReceived(JSON.parse(n));break;case x[J]:h.events.onSystemMessageReceived(JSON.parse(n));break;case x[I]:h.events.onFileMessageReceived(JSON.parse(n));break;case x[L]:h.events.onStructuedMessageReceived(JSON.parse(n));break;case x[w]:h.events.onBroadcastMessageReceived(JSON.parse(n));break;case x[j]:h.debugMessage(x[j]);break;default:h.events.onUndefinedMessageReceived(e,JSON.parse(n))}return JSON.parse(n)},h.close=function(){h.clear()},h.reconnect=function(){null==M?(h.debugMessage("Clear websocket."),h.debugMessage("Retry starts."),M=setTimeout(function(){h.connect(),M=null,h.debugMessage("Retry done.")},3e3)):h.debugMessage("Retry is in progress. (skip)")},h.command=function(e,n){msg=e+JSON.stringify(n)+"\n",m&&m.send(msg)},h.login=function(e){this.command(x[B],{"key":e})},h.join=function(e,n){this.command(x[D],{"channel_id":e,"last_message_ts":n})},h.ping=function(){var e=(new Date).getTime();F.lastPingTS=e,this.command(x[G],{"id":e})},h.msg=function(e){this.command(x[P],{"channel_id":h.channel.id,"message":e})},h.uploadFile=function(e){var n=_(e,h.user);return n},h.fileMsg=function(e){this.command(x[I],{"channel_id":h.channel.id,"name":e.name,"url":e.url,"type":e.type,"size":e.size,"custom":e.custom})},h.getMemberList=function(e){var n=r(h.user,e);return n},h.getChannelList=function(e,n){var s,t;return n>0&&null!=n&&void 0!=n||(n=20),e>0&&null!=e&&void 0!=e||(e=1),s="",t=c(h.user,e,n,s)},h.getChannelSearch=function(e,n,s){s>0&&null!=s&&void 0!=s||(s=20),n>0&&null!=n&&void 0!=n||(n=1);var t=c(h.user,n,s,e);return t},h.channelLeave=function(e){var n=g(h.user,e);return n},h.getMessagingChannelList=function(e,n){n>0&&null!=n&&void 0!=n||(n=9999),e>0&&null!=e&&void 0!=e||(e=1);var s=l(h.user,e,n);return s},h.messageLoadMore=function(){var e=d(h.user,h.channel,F.lastMessageTS);return $.each(e,function(e,n){F.lastMessageTS>n.ts&&(F.lastMessageTS=n.ts)}),e},h.startMessaging=function(e){var n=f(h.user,e);return h.debugMessage(n),n},h.inviteMessaging=function(e){var n=p(h.user,h.channel,e);return h.debugMessage(n),n},h.endMessaging=function(e){var n=v(h.user,e);return h.debugMessage(n),n},void h.start())}function n(e){var n=this;e=e,n.channel={"create":function(n,s){var t,a={};return a.auth=e,a.channel_url=n,a.name=s,t=h(a)}}}function s(e){(null===e||void 0===e||0==e.length)&&alert("app_id error!!")}function t(e){return m+"v"+M.replace(/[^(0-9)]/gi,"")+"/"+e}function a(e){return m+e}function i(e,n,s,t){$.ajax({"method":"POST","url":e,"contentType":"text/plain;charset=utf-8","data":JSON.stringify(n),"async":!1}).done(function(e){s(e)}).fail(function(e,n,s){t(e,n,s)})}function u(e){var n="guest_login/",s={"guest_id":e.guest_id,"app_id":e.app_id,"nickname":e.user_name,"image_url":e.image_url},a="";return i(t(n),s,function(e){a=e.key},function(){}),a}function o(e,n){var s="channel_join/",a={"app_id":e.app_id,"session_key":e.guest_key,"channel_url":n},u={};return i(t(s),a,function(e){u=e},function(){}),u}function r(e,n){var s="member_list/",a={"app_id":e.app_id,"channel_url":n},u={};return i(t(s),a,function(e){u=e},function(){}),u}function c(e,n,s,a){var u="channel_list/",o={"app_id":e.app_id,"page":n,"limit":s,"query":a},r={};return i(t(u),o,function(e){r=e},function(){}),r}function g(e,n){var s="channel_leave",a={"app_id":e.app_id,"session_key":e.guest_key,"channel_url":n},u={};return i(t(s),a,function(e){u=e},function(){}),u}function l(e,n,s){var a="messaging_list/",u={"app_id":e.app_id,"session_key":e.guest_key,"page":n,"limit":s},o={};return i(t(a),u,function(e){o=e},function(){}),o}function d(e,n,s){var a,u,o="message_list",r={"app_id":e.app_id,"session_key":e.guest_key,"channel_url":n.channel_url,"message_ts":s,"prev_limit":15,"next_limit":0,"include":!1},c={};return i(t(o),r,function(e){c=e},function(){}),a=[],u=0,$.each(c.messages,function(e,n){var s=n.substring(0,4),t=n.substring(4);"MESG"==s&&(a[u]=JSON.parse(t),u++)}),a}function f(e,n){var s="messaging_start/",a={"app_id":e.app_id,"session_key":e.guest_key,"guest_id":n},u={};return i(t(s),a,function(e){u=e},function(){}),u}function p(e,n,s){var a="messaging_invite/",u={"app_id":e.app_id,"session_key":e.guest_key,"channel_url":n.channel_url,"guest_ids":[s]},o={};return i(t(a),u,function(e){o=e},function(){}),o}function v(e,n){var s="messaging_end/",a={"app_id":e.app_id,"session_key":e.guest_key,"channel_url":n},u={};return i(t(s),a,function(e){u=e},function(){}),u}function _(e,n){var s,t="upload_file/",a='{"app_id": "'+n.app_id+'"}',i=new FormData;return i.append("meta",a),i.append("file",e),s="",$.ajax({"type":"POST","url":m+"v"+M.replace(/[^(0-9)]/gi,"")+"/"+t,"data":i,"processData":!1,"contentType":!1,"async":!1,"success":function(e){s=e.url}}),s}function h(e){var n="channel/create",s={};return i(a(n),e,function(e){s=e},function(){}),s}var m="https://api.jiver.co/",M="1";this.Jiver=e,this.JiverAPI=n}.call(this);