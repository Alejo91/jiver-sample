var isLeavingPage=!1;$(window).bind("beforeunload",function(){isLeavingPage=!0}),function(){function e(i){function a(e,n){M.debugMessage("jiver web socket start"),M.recvBuf="",n.lastMessageTS=(new Date).getTime(),e.onmessage=function(e){var s,t,i,a;for(n.lastActiveTS=(new Date).getTime(),M.recvBuf+=e.data,s=M.recvBuf.split("\n"),""!=s[s.length-1]?(M.recvBuf=s[s.length-1],s[s.length-1]=""):M.recvBuf="",t=0;t<s.length;t++)0!=s[t].trim().length&&(i=s[t].substring(0,4),a=s[t].substring(4),(0!==i.trim().length||0!==a.trim().length)&&("PONG"===i&&o(!1),n.onmessage(i,a),n.lastMessageTS=n.lastMessageTS>JSON.parse(a).ts?JSON.parse(a).ts:n.lastMessageTS))},e.onopen=function(e){n.onopen(e),h(!0)},e.onerror=function(e){n.onerror(e),h(!1),o(!1)},e.onclose=function(e){n.onclose(e),h(!1),o(!1)}}function o(e){null!=y&&(clearInterval(y),y=null),e?(M.debugMessage("Watchdog starts."),y=setInterval(function(){var e=(new Date).getTime(),n=e-P.lastActiveTS,s=parseInt(n/1e3);20>s||(M.debugMessage("Watchdog Barks!"),h(!1),M.close(),M.reconnect())},4500)):M.debugMessage("Watchdog stops.")}function h(e){null!=b&&(clearInterval(b),b=null),e?(M.debugMessage("Pinger starts."),b=setInterval(function(){var e=(new Date).getTime(),n=e-P.lastActiveTS,s=parseInt(n/1e3);s>0&&s%5==0&&(M.debugMessage(A[F]),M.ping(),o(!0))},1e3)):M.debugMessage("Pinger stops.")}var M,S,x,b,y,k,T,O,N,R,P;if(!this instanceof e)return new e(arguments);n(i.app_id),M=this,S=null,x=null,b=null,y=null,k=!1,M.user={},$.extend(this.user,i),T=this.user.app_id,O=null,N=null,R=0,M.channel={};const J="wss://ws.jiver.co:9010",w="MESG",I="SYSM",L="FILE",D="BRDM",G="STRU",B="LOGI",j="JOIN",F="PING",C="PONG",A={"MESG":w,"SYSM":I,"FILE":L,"BRDM":D,"STRU":G,"LOGI":B,"JOIN":j,"PING":F,"PONG":C};M.events={"onMessageReceived":function(e){console.log(e)},"onSystemMessageReceived":function(e){console.log(e)},"onFileMessageReceived":function(e){console.log(e)},"onBroadcastMessageReceived":function(e){console.log(e)},"onStructuedMessageReceived":function(e){console.log(e)},"onUndefinedMessageReceived":function(e,n){M.debugMessage(e),M.debugMessage(n)}},M.options={"onopen":function(){M.login(M.user.guest_key),M.join(M.channel.id,R)},"onmessage":function(e,n){M.messageProcess(e,n)},"onclose":function(){M.debugMessage("on close"),isLeavingPage||M.reconnect()},"onerror":function(){M.debugMessage("on error"),isLeavingPage||M.reconnect()},"lastActiveTS":0,"lastPingTS":0,"lastMessageTS":0},P=M.options,M.setDebugMessage=function(e){k=e},M.debugMessage=function(e){k&&console.log(e)},M.start=function(){M.user.guest_id=t(),M.user.guest_key=r(M.user)},M.joinChannel=function(e){var n=u(M.user,e);return $.extend(M.channel,n),M.debugMessage(M.channel),M.connect(),M.channel},M.connect=function(){M.debugMessage("try connect"),M.clear(),S=$.gracefulWebSocket(J),a(S,P)},M.clear=function(){S&&(S.onmessage=function(){},S.onopen=function(){},S.onerror=function(){},S.onclose=function(){},S=null)},M.messageProcess=function(e,n){switch(e){case A[w]:M.events.onMessageReceived(JSON.parse(n));break;case A[I]:M.events.onSystemMessageReceived(JSON.parse(n));break;case A[L]:M.events.onFileMessageReceived(JSON.parse(n));break;case A[G]:M.events.onStructuedMessageReceived(JSON.parse(n));break;case A[D]:M.events.onBroadcastMessageReceived(JSON.parse(n));break;case A[C]:M.debugMessage(A[C]);break;default:M.events.onUndefinedMessageReceived(e,JSON.parse(n))}return JSON.parse(n)},M.close=function(){S.close()},M.reconnect=function(){null==x?(M.debugMessage("Clear websocket."),M.debugMessage("Retry starts."),x=setTimeout(function(){M.connect(),x=null,M.debugMessage("Retry done.")},3e3)):M.debugMessage("Retry is in progress. (skip)")},M.command=function(e,n){msg=e+JSON.stringify(n)+"\n",console.log(JSON.stringify(n)),S.send(msg)},M.login=function(e){this.command(A[B],{"key":e})},M.join=function(e,n){this.command(A[j],{"channel_id":e,"last_message_ts":n})},M.ping=function(){var e=(new Date).getTime();P.lastPingTS=e,this.command(A[F],{"id":e})},M.msg=function(e){this.command(A[w],{"channel_id":M.channel.id,"message":e})},M.uploadFile=function(e){var n=m(e);return n},M.fileMsg=function(e){this.command(A[L],{"channel_id":M.channel.id,"name":e.name,"url":e.url,"type":e.type,"size":e.size,"custom":e.custom})},M.getMemberList=function(e){var n=c(M.user,e);return n},M.getChannelList=function(e,n){var s,t;return n>0&&null!=n&&void 0!=n||(n=20),e>0&&null!=e&&void 0!=e||(e=1),s="",t=g(M.user,e,n,s)},M.getChannelSearch=function(e,n,s){s>0&&null!=s&&void 0!=s||(s=20),n>0&&null!=n&&void 0!=n||(n=1);var t=g(M.user,n,s,e);return t},M.channelLeave=function(e){var n=l(M.user,e);return n},M.getMessagingChannelList=function(e,n){n>0&&null!=n&&void 0!=n||(n=9999),e>0&&null!=e&&void 0!=e||(e=1);var s=f(M.user,e,n);return s},M.isCurrentUser=function(e){return s()==e?!0:!1},M.messageLoadMore=function(){var e=d(M.user,M.channel,P.lastMessageTS);return $.each(e,function(e,n){P.lastMessageTS>n.ts&&(P.lastMessageTS=n.ts)}),e},M.startMessaging=function(e){var n=p(M.user,e);return console.log(n),n},M.inviteMessaging=function(e){var n=v(M.user,M.channel,e);return console.log(n),n},M.endMessaging=function(e){var n=_(M.user,e);return console.log(n),n},M.start()}function n(e){(null===e||void 0===e||0==e.length)&&alert("app_id error!!")}function s(){var e,n,s="guest_id=",t=document.cookie.split(";");for(e=0;e<t.length;e++){for(n=t[e];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(s))return n.substring(s.length,n.length)}return""}function t(){var e=s();return 0==e.trim().length?i():e}function i(){var e=(new Date).getTime(),n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var s=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==n?s:3&s|8).toString(16)});return a(n)}function a(e){return document.cookie="guest_id="+e+"; expires=Fri, 31 Dec 9999 23:59:59 GMT",e}function o(e,n,s,t){$.ajax({"method":"POST","url":h+"v"+M.replace(/[^(0-9)]/gi,"")+"/"+e,"contentType":"text/plain;charset=utf-8","data":JSON.stringify(n),"async":!1}).done(function(e){s(e)}).fail(function(e,n,s){t(e,n,s)})}function r(e){var n="guest_login/",s={"guest_id":e.guest_id,"app_id":e.app_id,"nickname":e.user_name,"image_url":e.image_url},t="";return o(n,s,function(e){t=e.key},function(){}),t}function u(e,n){var s="channel_join/",t={"app_id":e.app_id,"session_key":e.guest_key,"channel_url":n},i={};return o(s,t,function(e){i=e},function(){}),i}function c(e,n){var s="member_list/",t={"app_id":e.app_id,"channel_url":n},i={};return o(s,t,function(e){i=e},function(){}),i}function g(e,n,s,t){var i="channel_list/",a={"app_id":e.app_id,"page":n,"limit":s,"query":t},r={};return o(i,a,function(e){r=e},function(){}),r}function l(e,n){var s="channel_leave",t={"app_id":e.app_id,"session_key":e.guest_key,"channel_url":n},i={};return o(s,t,function(e){i=e},function(){}),i}function f(e,n,s){var t="messaging_list/",i={"app_id":e.app_id,"session_key":e.guest_key,"page":n,"limit":s},a={};return o(t,i,function(e){a=e},function(){}),a}function d(e,n,s){var t,i,a="message_list",r={"app_id":e.app_id,"session_key":e.guest_key,"channel_url":n.channel_url,"message_ts":s,"prev_limit":15,"next_limit":0,"include":!1},u={};return o(a,r,function(e){u=e},function(){}),t=[],i=0,$.each(u.messages,function(e,n){var s=n.substring(0,4),a=n.substring(4);"MESG"==s&&(t[i]=JSON.parse(a),i++)}),t}function p(e,n){var s="messaging_start/",t={"app_id":e.app_id,"session_key":e.guest_key,"guest_id":n},i={};return o(s,t,function(e){i=e},function(){}),i}function v(e,n,s){var t="messaging_invite/",i={"app_id":e.app_id,"session_key":e.guest_key,"channel_url":n.channel_url,"guest_ids":[s]},a={};return o(t,i,function(e){a=e},function(){}),a}function _(e,n){var s="messaging_end/",t={"app_id":e.app_id,"session_key":e.guest_key,"channel_url":n},i={};return o(s,t,function(e){i=e},function(){}),i}function m(e){var n,s="upload_file/",t='{"app_id": "'+appId+'"}',i=new FormData;return i.append("meta",t),i.append("file",e),n="",$.ajax({"type":"POST","url":h+"v"+M.replace(/[^(0-9)]/gi,"")+"/"+s,"data":i,"processData":!1,"contentType":!1,"async":!1,"success":function(e){n=e.url}}),n}const h="https://api.jiver.co/",M="1";this.Jiver=e}.call(this);